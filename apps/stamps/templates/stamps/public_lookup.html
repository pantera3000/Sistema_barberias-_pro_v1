{% extends 'base_customer.html' %}

{% block title %}Consulta de Sellos - {{ organization.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="glass-card overflow-hidden mb-4 border-0">
            <!-- Header con Gradient din√°mico -->
            <div class="p-4 text-center text-white" style="background: linear-gradient(135deg, var(--primary-color) 0%, rgba(0,0,0,0.9) 100%);">
                <div class="mb-3">
                    {% if organization.logo %}
                        <img src="{{ organization.logo.url }}" alt="Logo" style="height: 60px; border-radius: 14px; background: white; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    {% else %}
                        <div class="rounded-circle bg-white bg-opacity-20 d-inline-flex p-3 backdrop-blur">
                            <i class="fas fa-ticket-alt fs-2"></i>
                        </div>
                    {% endif %}
                </div>
                <h4 class="fw-bold mb-0 font-heading letter-spacing-1">{{ organization.name }}</h4>
                <p class="small opacity-75 mb-0 text-uppercase fw-600">Portal de Fidelidad</p>
            </div>

            <!-- Search Body -->
            <div class="p-4 p-md-5 bg-white bg-opacity-50">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-4 small border-0 shadow-sm mb-4" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="GET" class="mb-4 text-center">
                    <label class="form-label small fw-bold text-muted text-uppercase mb-3 letter-spacing-1">Tu n√∫mero de tel√©fono</label>
                    <div class="input-group search-input-group mb-4">
                        <span class="input-group-text bg-transparent border-0 ps-0">
                            <i class="fas fa-phone text-primary opacity-50"></i>
                        </span>
                        <input type="tel" name="phone" value="{{ phone }}" class="form-control border-0 bg-transparent text-center font-heading fw-bold" 
                               placeholder="999 999 999" required style="font-size: 1.5rem;">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 shadow-lg text-uppercase fw-bold letter-spacing-1 transition-all hover-scale">
                        <i class="fas fa-search me-2"></i> Consultar mis Sellos
                    </button>
                </form>

                {% if phone %}
                    <hr class="my-5 opacity-10">
                    
                    {% if customer %}
                        <div class="text-center mb-5">
                            <h5 class="fw-bold text-dark mb-1 font-heading">¬°Hola, {{ customer.first_name }}! üëã</h5>
                            <p class="text-muted small">Tienes {{ cards|length }} tarjeta(s) activas.</p>
                        </div>

                        {% for card in cards %}
                            <div class="premium-digital-card mb-4">
                                <div class="card-glass-body p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <div>
                                            <span class="d-block small text-muted text-uppercase fw-bold letter-spacing-1 mb-1">Promoci√≥n</span>
                                            <h5 class="fw-bold mb-0 font-heading">{{ card.promotion.name }}</h5>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge rounded-pill bg-dark py-2 px-3 fw-bold shadow-sm">
                                                {{ card.current_stamps }}/{{ card.promotion.total_stamps_needed }}
                                            </span>
                                            {% if card.pending_count > 0 %}
                                                <div class="mt-1">
                                                    <span class="badge rounded-pill bg-warning text-dark py-1 px-2 x-small blink">
                                                        +{{ card.pending_count }} pendiente(s)
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="stamp-grid-modern">
                                        {% with ""|center:card.promotion.total_stamps_needed as range %}
                                        {% for _ in range %}
                                            {% if forloop.counter <= card.current_stamps %}
                                                <div class="stamp-slot active">
                                                    <i class="fas fa-stamp" style="color: {{ card.promotion.primary_color|default:organization.primary_color }}"></i>
                                                </div>
                                            {% elif forloop.counter <= card.current_stamps|add:card.pending_count %}
                                                <div class="stamp-slot pending blink">
                                                    <i class="fas fa-stamp opacity-40" style="color: {{ card.promotion.primary_color|default:organization.primary_color }}"></i>
                                                </div>
                                            {% else %}
                                                <div class="stamp-slot empty">
                                                    <span class="opacity-30 small fw-bold">{{ forloop.counter }}</span>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% endwith %}
                                    </div>

                                    <div class="mt-4 text-center">
                                        {% if card.is_completed %}
                                            <div class="btn-reward-ready w-100 py-2 fw-bold text-uppercase">
                                                <i class="fas fa-gift me-2"></i> ¬°LISTA PARA CANJEAR!
                                            </div>
                                        {% else %}
                                            <div class="progress rounded-pill bg-dark bg-opacity-5 mb-2" style="height: 8px;">
                                                <div class="progress-bar progress-bar-animated bg-primary" role="progressbar" 
                                                     style="width: {% widthratio card.current_stamps card.promotion.total_stamps_needed 100 %}%"></div>
                                            </div>
                                            <p class="x-small text-muted mb-0 fw-bold text-uppercase opacity-75">
                                                {% if card.pending_count > 0 %}
                                                    <span class="text-warning">Esperando confirmaci√≥n de {{ card.pending_count }} sello(s)</span>
                                                {% else %}
                                                    Faltan {{ card.promotion.total_stamps_needed|add:"-"|add:card.current_stamps }} sellos para tu premio
                                                {% endif %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        
                        {% if not customer.birth_day or not customer.dni %}
                        <div class="nudge-gift-card p-4 rounded-4 mb-4 text-center">
                            {% if not customer.birth_day %}
                                <div class="fs-1 mb-2 animate-bounce">üéÇ</div>
                                <h5 class="fw-bold text-dark mb-2 font-heading">Regalo de Cumplea√±os</h5>
                                <p class="small text-muted mb-3 px-3">Cu√©ntanos cu√°ndo es tu d√≠a especial para enviarte sorpresas exclusivas.</p>
                            {% else %}
                                <div class="fs-1 mb-2 animate-bounce">üë§</div>
                                <h5 class="fw-bold text-dark mb-2 font-heading">Perfil Premium</h5>
                                <p class="small text-muted mb-3 px-3">Completa tu DNI para validar tu identidad y acceder a m√°s beneficios.</p>
                            {% endif %}
                            <button type="button" class="btn btn-warning rounded-pill px-5 fw-bold shadow-sm hover-scale" data-bs-toggle="modal" data-bs-target="#nudgeModal">
                                ¬°Completar mi perfil!
                            </button>
                        </div>
                        {% endif %}

                        <div class="alert alert-primary bg-opacity-10 border-0 rounded-4 small text-center mt-4 p-3 shadow-inner">
                            <i class="fas fa-shield-alt me-2 text-primary"></i> Identif√≠cate con este n√∫mero en cada visita.
                        </div>
                    {% else %}
                        <div class="text-center py-5 bg-light bg-opacity-50 rounded-4 border-dashed">
                            <i class="fas fa-user-slash fa-3x text-muted mb-3 opacity-20"></i>
                            <h6 class="fw-bold text-muted">¬øEres nuevo?</h6>
                            <p class="text-muted small px-4">No encontramos tarjetas para este n√∫mero. Reg√≠strate en tu pr√≥xima visita para empezar a ganar.</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5 opacity-40">
                        <i class="fas fa-wallet fa-4x mb-4 text-primary animate-pulse"></i>
                        <h6 class="fw-bold mb-1">Tus Premios en un solo lugar</h6>
                        <p class="small mb-0">Ingresa tu n√∫mero para ver tu progreso.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="text-center pb-5">
            <a href="/" class="btn btn-link text-muted text-decoration-none small hover-primary transition-all">
                <i class="fas fa-home me-2"></i> Volver al inicio
            </a>
        </div>
    </div>
</div>

<!-- Modal Nudge Moderno -->
{% if customer %}
<div class="modal fade" id="nudgeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-0 shadow-lg p-3">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="display-4 mb-3 animate-wiggle">üéÅ</div>
                <h4 class="fw-bold font-heading mb-2">¬°Queremos premiarte!</h4>
                <p class="text-muted small mb-4">Solo necesitamos unos datos b√°sicos para validar tu perfil premium.</p>
                
                <form id="nudgeForm">
                    <input type="hidden" name="customer_id" value="{{ customer.id }}">
                    
                    <div class="mb-3 text-start">
                        <label class="form-label small fw-bold text-muted text-uppercase letter-spacing-1">Nombre completo</label>
                        <input type="text" name="first_name" value="{{ customer.first_name|default:'' }}" class="form-control rounded-4 py-3 bg-light border-0 shadow-sm" required>
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label small fw-bold text-muted text-uppercase letter-spacing-1">DNI / Documento</label>
                        <input type="text" name="dni" value="{{ customer.dni|default:'' }}" class="form-control rounded-4 py-3 bg-light border-0 shadow-sm" required>
                    </div>

                    <div class="row g-2 mb-4 text-start">
                        <label class="form-label small fw-bold text-muted text-uppercase letter-spacing-1 col-12">Tu Cumplea√±os</label>
                        <div class="col-5">
                            <select name="birth_day" class="form-select rounded-4 py-3 bg-light border-0 shadow-sm" required>
                                <option value="">D√≠a</option>
                                {% for i in days_range %}
                                <option value="{{ i }}" {% if customer.birth_day == i %}selected{% endif %}>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-7">
                            <select name="birth_month" class="form-select rounded-4 py-3 bg-light border-0 shadow-sm" required>
                                <option value="">Mes</option>
                                <option value="1" {% if customer.birth_month == 1 %}selected{% endif %}>Enero</option>
                                <option value="2" {% if customer.birth_month == 2 %}selected{% endif %}>Febrero</option>
                                <option value="3" {% if customer.birth_month == 3 %}selected{% endif %}>Marzo</option>
                                <option value="4" {% if customer.birth_month == 4 %}selected{% endif %}>Abril</option>
                                <option value="5" {% if customer.birth_month == 5 %}selected{% endif %}>Mayo</option>
                                <option value="6" {% if customer.birth_month == 6 %}selected{% endif %}>Junio</option>
                                <option value="7" {% if customer.birth_month == 7 %}selected{% endif %}>Julio</option>
                                <option value="8" {% if customer.birth_month == 8 %}selected{% endif %}>Agosto</option>
                                <option value="9" {% if customer.birth_month == 9 %}selected{% endif %}>Septiembre</option>
                                <option value="10" {% if customer.birth_month == 10 %}selected{% endif %}>Octubre</option>
                                <option value="11" {% if customer.birth_month == 11 %}selected{% endif %}>Noviembre</option>
                                <option value="12" {% if customer.birth_month == 12 %}selected{% endif %}>Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow-lg text-uppercase letter-spacing-1">
                        ¬°Guardar y Recibir Sorpresas!
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    /* Tipograf√≠a y Espaciado */
    .letter-spacing-1 { letter-spacing: 1px; }
    .fw-600 { font-weight: 600; }
    .x-small { font-size: 0.7rem; }
    .shadow-inner { box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }

    /* Inputs Modernos */
    .search-input-group {
        background: #f8fafc;
        border-radius: 20px;
        padding: 5px 20px;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    .search-input-group:focus-within {
        border-color: var(--primary-color);
        background: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Tarjeta Digital Premium */
    .premium-digital-card {
        background: white;
        border-radius: 28px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        position: relative;
        overflow: hidden;
        border: 1px solid #f1f5f9;
    }
    .premium-digital-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; height: 120px;
        background: linear-gradient(180deg, rgba(var(--primary-color-rgb, 59, 130, 246), 0.05) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }

    /* Cuadr√≠cula de Sellos Moderna */
    .stamp-grid-modern {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        background: #fdfdfd;
        padding: 20px;
        border-radius: 20px;
        border: 1px solid #f1f5f9;
    }
    .stamp-slot {
        aspect-ratio: 1/1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .stamp-slot.active {
        background: #fff;
        border: 2px solid rgba(var(--primary-color-rgb, 59, 130, 246), 0.1);
        transform: rotate(-10deg) scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .stamp-slot.empty {
        border: 2px dashed #e2e8f0;
        background: #fbfcfd;
    }
    .stamp-slot.pending {
        border: 2px dashed var(--primary-color);
        background: rgba(var(--primary-color-rgb, 59, 130, 246), 0.02);
    }

    /* Estados Especiales */
    .btn-reward-ready {
        background: #10b981;
        color: white;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
    }
    .nudge-gift-card {
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        border: 1px solid rgba(249, 115, 22, 0.1);
    }
    .border-dashed { border: 2px dashed #e2e8f0; }

    /* Animaciones */
    @keyframes blink {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.95); }
    }
    .blink { animation: blink 1.5s infinite ease-in-out; }

    @keyframes pulse-soft {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 0.7; }
    }
    .animate-pulse { animation: pulse-soft 3s infinite; }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    .animate-bounce { animation: bounce 2s infinite; }

    .hover-scale:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .transition-all { transition: all 0.3s ease; }
    .backdrop-blur { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('nudgeForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Guardando...';

        const formData = new FormData(this);
        fetch('{% url "stamps:api_customer_nudge" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                location.reload();
            } else {
                alert(data.error || 'Error al guardar');
                btn.disabled = false;
                btn.innerText = '¬°Guardar y Recibir Sorpresas!';
            }
        });
    });
</script>
{% endblock %}
