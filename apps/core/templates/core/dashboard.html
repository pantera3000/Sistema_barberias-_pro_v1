
{% extends 'base.html' %}

{% block title %}Dashboard - {{ user.organization.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Bienvenido, {{ user.first_name }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Compartir</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Exportar</button>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
            <i class="fas fa-calendar"></i> Esta semana
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4 mb-4">
    <div class="col">
        <div class="card h-100 shadow-sm border-start border-4 border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="card-title text-muted mb-0">Clientes Totales</h6>
                    <div class="icon-shape bg-primary bg-opacity-10 text-primary rounded-circle p-2">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <h3 class="fw-bold mb-1">{{ total_customers }}</h3>
                <small class="text-success"><i class="fas fa-arrow-up"></i> {{ new_customers_today }} hoy</small>
            </div>
        </div>
    </div>
    
    <div class="col">
        <div class="card h-100 shadow-sm border-start border-4 border-success">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="card-title text-muted mb-0">Puntos Emitidos (Hoy)</h6>
                    <div class="icon-shape bg-success bg-opacity-10 text-success rounded-circle p-2">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <h3 class="fw-bold mb-1">{{ points_today }}</h3>
                <small class="text-muted">Fidelización activa</small>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 shadow-sm border-start border-4 border-warning">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="card-title text-muted mb-0">Tarjetas Activas</h6>
                    <div class="icon-shape bg-warning bg-opacity-10 text-warning rounded-circle p-2">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                </div>
                <h3 class="fw-bold mb-1">{{ active_stamp_cards }}</h3>
                <small class="text-muted">En progreso</small>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 shadow-sm border-start border-4 border-info">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="card-title text-muted mb-0">Citas Hoy</h6>
                    <div class="icon-shape bg-info bg-opacity-10 text-info rounded-circle p-2">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
                <h3 class="fw-bold mb-1">0</h3>
                <small class="text-muted">Próximamente</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-chart-line text-primary me-2"></i> Crecimiento de Clientes (Últimos 30 días)</h6>
            </div>
            <div class="card-body">
                <canvas id="growthChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-chart-pie text-info me-2"></i> Promociones Populares</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <canvas id="promoChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-chart-bar text-success me-2"></i> Actividad de Sellos (Otorgados vs Canjeados)</h6>
            </div>
            <div class="card-body">
                <canvas id="activityChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
    <!-- Recent Activity -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Actividad Reciente</h6>
                <a href="{% url 'loyalty:transaction_list' %}" class="btn btn-sm btn-link text-decoration-none">Ver todo</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Hora</th>
                            <th>Cliente</th>
                            <th>Acción</th>
                            <th class="text-end">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in recent_activity %}
                        <tr>
                            <td>{{ txn.created_at|date:"H:i" }}</td>
                            <td class="fw-bold">{{ txn.customer.full_name }}</td>
                            <td>
                                {% if txn.transaction_type == 'EARN' %}
                                <span class="badge bg-success-subtle text-success">Ganó Puntos</span>
                                {% elif txn.transaction_type == 'REDEEM' %}
                                <span class="badge bg-danger-subtle text-danger">Canjeó Puntos</span>
                                {% else %}
                                <span class="badge bg-secondary-subtle text-secondary">Ajuste</span>
                                {% endif %}
                                <small class="text-muted d-block">{{ txn.description|truncatechars:30 }}</small>
                            </td>
                            <td class="text-end fw-bold {% if txn.transaction_type == 'REDEEM' %}text-danger{% else %}text-success{% endif %}">
                                {% if txn.transaction_type == 'REDEEM' %}-{% else %}+{% endif %}{{ txn.points }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">No hay actividad reciente.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">Acciones Rápidas</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'customers:customer_create' %}" class="btn btn-outline-primary text-start p-3">
                        <i class="fas fa-user-plus me-3 fa-lg"></i> Nuevo Cliente
                    </a>
                    <a href="{% url 'loyalty:assign_points' %}" class="btn btn-outline-success text-start p-3">
                        <i class="fas fa-star me-3 fa-lg"></i> Asignar Puntos
                    </a>
                    <a href="{% url 'stamps:assign_stamps' %}" class="btn btn-outline-warning text-start p-3">
                        <i class="fas fa-stamp me-3 fa-lg"></i> Poner Sello
                    </a>
                    <a href="{% url 'rewards:redeem_reward' %}" class="btn btn-outline-danger text-start p-3">
                        <i class="fas fa-gift me-3 fa-lg"></i> Canjear Premio
                    </a>
                    <a href="{% url 'services:service_list' %}" class="btn btn-outline-secondary text-start p-3">
                        <i class="fas fa-cut me-3 fa-lg"></i> Editar Servicios
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Confeti de Cumpleaños ---
        {% if has_birthday_today %}
        var duration = 5 * 1000;
        var animationEnd = Date.now() + duration;
        var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            var particleCount = 50 * (timeLeft / duration);
            // since particles fall down, start a bit higher than random
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
        }, 250);
        {% endif %}

        fetch("{% url 'core:dashboard_stats_api' %}")
            .then(response => response.json())
            .then(data => {
                renderGrowthChart(data.customer_growth);
                renderPromoChart(data.promo_stats);
                renderActivityChart(data.stamp_activity);
            });
    });

    function renderGrowthChart(stats) {
        const ctx = document.getElementById('growthChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: stats.map(s => s.date),
                datasets: [{
                    label: 'Nuevos Clientes',
                    data: stats.map(s => s.count),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { stepSize: 1, precision: 0 } 
                    } 
                }
            }
        });
    }

    function renderPromoChart(stats) {
        const ctx = document.getElementById('promoChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: stats.map(s => s.name),
                datasets: [{
                    data: stats.map(s => s.card_count),
                    backgroundColor: ['#0d6efd', '#0dcaf0', '#198754', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                aspectRatio: 1.5,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderActivityChart(stats) {
        const ctx = document.getElementById('activityChart').getContext('2d');
        
        // Agrupar datos por fecha para el gráfico de barras comparativo
        const dates = [...new Set(stats.map(s => s.date))];
        const addData = dates.map(d => {
            const item = stats.find(s => s.date === d && s.action === 'ADD');
            return item ? item.count : 0;
        });
        const redeemData = dates.map(d => {
            const item = stats.find(s => s.date === d && s.action === 'REDEEM');
            return item ? Math.abs(item.count) : 0;
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Sellos Otorgados',
                        data: addData,
                        backgroundColor: '#0d6efd'
                    },
                    {
                        label: 'Canjes Realizados',
                        data: redeemData,
                        backgroundColor: '#198754'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    } 
                }
            }
        });
    }
</script>
{% endblock %}
