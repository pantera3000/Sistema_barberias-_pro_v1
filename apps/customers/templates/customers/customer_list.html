
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .hover-primary:hover {
        color: var(--bs-primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0 d-flex gap-2">
        <div class="input-group">
            <input type="text" id="customerSearch" class="form-control" placeholder="Buscar cliente..." aria-label="Buscar" value="{{ query|default:'' }}">
            <button id="searchBtn" class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
        </div>
        
        {% if user.has_feature_import_csv %}
        <a href="#" class="btn btn-outline-secondary">
            <i class="fas fa-file-import"></i> <span class="d-none d-lg-inline">Importar</span>
        </a>
        {% endif %}

        {% if user.has_feature_export_data %}
        <a href="#" class="btn btn-outline-secondary">
            <i class="fas fa-file-export"></i> <span class="d-none d-lg-inline">Exportar</span>
        </a>
        {% endif %}

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCustomerModal">
            <i class="fas fa-user-plus"></i> <span class="d-none d-lg-inline">Nuevo Cliente</span>
            <i class="fas fa-plus d-lg-none"></i>
        </button>
    </div>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nombre y Apellido</th>
                    <th>Contacto</th>
                    <th>Cumpleaños</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody id="customerTableBody">
                {% include 'customers/partials/customer_table_rows.html' %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo Cliente -->
<div class="modal fade" id="newCustomerModal" tabindex="-1" aria-labelledby="newCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="newCustomerModalLabel"><i class="fas fa-user-plus me-2"></i> Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="newCustomerForm" method="post" action="{% url 'customers:customer_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Nombre</label>
                            {{ form.first_name }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Apellido</label>
                            {{ form.last_name }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email</label>
                            {{ form.email }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Teléfono</label>
                            {{ form.phone }}
                        </div>
                        <div class="col-12 mt-4">
                            <p class="text-muted small border-bottom pb-2">Fecha de Cumpleaños (Opcional)</p>
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="form-label small">Día</label>
                                    {{ form.birth_day }}
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Mes</label>
                                    {{ form.birth_month }}
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Año</label>
                                    {{ form.birth_year }}
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Notas</label>
                            {{ form.notes }}
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch card p-3 bg-light border-0">
                                {{ form.auto_assign_stamps }}
                                <label class="form-check-label fw-bold ms-2" for="{{ form.auto_assign_stamps.id_for_label }}">
                                    Asignar tarjeta de sellos automáticamente
                                </label>
                                <small class="text-muted d-block ms-2">Si hay una promoción activa, se creará una tarjeta nueva para este cliente.</small>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center pb-4">
                <div class="rounded-circle bg-danger bg-opacity-10 text-danger d-inline-flex justify-content-center align-items-center mb-4" style="width: 80px; height: 80px;">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
                <h4 class="fw-bold mb-2">¿Eliminar cliente?</h4>
                <p class="text-muted mb-0">Esta acción no se puede deshacer. Se eliminarán todos los puntos y tarjetas de <strong id="deleteCustomerName"></strong>.</p>
            </div>
            <div class="modal-footer border-0 p-3 pt-0 d-flex gap-2">
                <button type="button" class="btn btn-light flex-grow-1 py-2 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteCustomerForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100 py-2 fw-bold px-4">Sí, Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('customerSearch');
        const tableBody = document.getElementById('customerTableBody');
        const searchBtn = document.getElementById('searchBtn');
        let debounceTimer;

        function performSearch() {
            const query = searchInput.value;
            fetch(`{% url 'customers:customer_list' %}?q=${encodeURIComponent(query)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                tableBody.innerHTML = html;
            });
        }

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
        });

        searchBtn.addEventListener('click', performSearch);

        // AJAX para el formulario de creación
        const newCustomerForm = document.getElementById('newCustomerForm');
        newCustomerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', // Podríamos usarlo en la view para retornar JSON
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.reload(); // Por ahora recargamos si se redirige con éxito
                } else {
                    // Si no redirige, podría haber errores de validación (manejo básico por ahora)
                    this.submit(); // Fallback al envío normal si hay problemas
                }
            });
        });

        // Manejo del modal de eliminación
        const deleteModal = document.getElementById('deleteCustomerModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const customerId = button.getAttribute('data-bs-id');
                const customerName = button.getAttribute('data-bs-name');
                
                const form = deleteModal.querySelector('#deleteCustomerForm');
                const nameSpan = deleteModal.querySelector('#deleteCustomerName');
                
                nameSpan.textContent = customerName;
                form.action = `/app/customers/${customerId}/delete/`;
            });
        }
    });
</script>
{% endblock %}
